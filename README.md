# nsq-demo

Этим Demo я хочу показать, что не обязательно использовать laravel jobs для работы 
с очередями

Пакет nsq.so - является доработанной версией https://pecl.php.net/package/nsq, 
исходный код доработанной версии можно найти https://github.com/androzd/php-nsq

Для запуска demo выполняем 

```shell script
docker-compose up -d
```

Нам понадобится 2 терминала (producer и consumer)

В обоих терминалах войдём в контейнер PHP

```shell script
docker-compose exec php bash
```

Покажу несколько кейсов:

- Попытка слушать несуществующий топик (это приводит к ошибке, и надо обсудить как быть в этом случае)

В первом терминале запускаем 
```shell script
php artisan job:listen
```

На данном этапе это приводит к exception, так как lookupd не знает ни одного nsqd с таким топиком
В данном случае наверное надо добавить обработчик subscribe чтобы если не найден топик, 
то мы пробовали слушать скажем раз в 10 секунд

- Запись сообщения в nsqd (1..10000)
Попробуем отправить сообщение в NSQD для этого вызовем команду
```shell script
php artisan produce:message 1
```

В данном случае 1 - это количество сообщений. 
Сообщения будут содержать Json с полями idи message, 
где id - порядковый номер сообщения в batch, 
а message - случайная цитата великих людей (такой функционал есть в laravel используется для демонстрации работы коллекций)


- Обработка сообщения из nsqd

Попробуем отправить сообщение в NSQD для этого вызовем команду
```shell script
php artisan job:listen
```

Так включается listener сообщений, для указанного в getTopic топика
Мы видим что сообщение успешно обработалось

- Запись и обработка сообщений занимает не так много времени
Так как топик у нас создан выполняем

```shell script
php artisan job:listen
```

Затем записываем 10000 сообщений в nsqd
```shell script
php artisan produce:message 10000
```

За время моего замера (вне докера) количество сообщений во время записи и обработки не превышало 200 сообщений

Но тут стоит учесть что обработка сообщения очень простая

- Демонстрация перевыставления с параметром retry_delay_time в BaseConsumer (Время указано в ms)

Для этого бросаем exception в коде, и задача перевыставится автоматически через 5 секунд
 
